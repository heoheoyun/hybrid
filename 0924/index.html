<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>부산 도시철도 가이드 🚇</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        :root {
            --bs-blue: #0d6efd;
            --bs-indigo: #6610f2;
            --bs-purple: #6f42c1;
            --bs-pink: #d63384;
            --bs-red: #dc3545;
            --bs-orange: #fd7e14;
            --bs-yellow: #ffc107;
            --bs-green: #198754;
            --bs-teal: #20c997;
            --bs-cyan: #0dcaf0;
            --bs-gray: #6c757d;
            --bs-gray-dark: #343a40;
            --line1-color: #E63333; /* 1호선 색상 */
            --line2-color: #00B168; /* 2호선 색상 */
            --line3-color: #FF8F00; /* 3호선 색상 */
            --line4-color: #60469E; /* 4호선 색상 */
            --light-rail-color: #00A3DA; /* 경전철 색상 */
            --default-marker-color: #6c757d; /* 기본 마커 색상 */
        }
        body {
            font-family: 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
            background-color: #f0f4f7;
            color: #34495e;
        }
        .container {
            max-width: 1100px;
            margin-top: 2rem;
            margin-bottom: 2rem;
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
            padding: 2.5rem;
        }
        h1, h2 {
            font-weight: 700;
            color: #2c3e50;
        }
        h1 {
            font-size: 2.5rem;
        }
        h2 {
            font-size: 1.75rem;
            margin-bottom: 1.5rem;
        }
        #map {
            height: 500px;
            width: 100%;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        .route-result {
            margin-top: 1.5rem;
            background-color: #eaf2f8;
            border: 1px solid #d4e6f1;
            padding: 1.5rem;
            border-radius: 8px;
        }
        .form-select, .btn {
            border-radius: 8px;
        }
        .btn-primary {
            background-color: #3498db;
            border-color: #3498db;
            font-weight: 600;
        }
        .btn-primary:hover {
            background-color: #2980b9;
            border-color: #2980b9;
        }
        .chart-container {
            margin-top: 2rem;
        }
        .leaflet-marker-icon.line-marker {
            border: 2px solid white;
            border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            font-weight: bold;
            text-align: center;
        }
        .line1-marker { background-color: var(--line1-color); }
        .line2-marker { background-color: var(--line2-color); }
        .line3-marker { background-color: var(--line3-color); }
        .line4-marker { background-color: var(--line4-color); }
        .light-rail-marker { background-color: var(--light-rail-color); }
        .transfer-marker { border: 3px solid #f39c12; }
        
        .result-content {
            font-size: 1.1rem;
        }
        .result-content strong {
            color: #2c3e50;
        }
        .result-content .text-primary {
            font-weight: 600;
        }
        .accordion-item .accordion-header .line-icon {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            margin-right: 10px;
        }
        .line-1-bg { background-color: var(--line1-color); }
        .line-2-bg { background-color: var(--line2-color); }
        .line-3-bg { background-color: var(--line3-color); }
        .line-4-bg { background-color: var(--line4-color); }
        .list-group-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
    </style>
</head>
<body>

<div class="container">
    <header class="text-center mb-5">
        <h1>🚆 부산 도시철도 가이드</h1>
        <p class="lead text-muted">지도를 통해 부산 지하철 노선과 역 정보를 확인하고, 편리하게 경로를 검색하세요.</p>
    </header>

    <div class="row mb-5">
        <div class="col-12">
            <h2>지하철 노선 지도</h2>
            <div id="map"></div>
        </div>
    </div>
    
    <hr class="my-4">

    <div class="row">
        <div class="col-12">
            <h2>경로 검색</h2>
            <div class="row g-3 align-items-end mb-3">
                <div class="col-md-5">
                    <label for="startStation" class="form-label">출발역</label>
                    <select id="startStation" class="form-select"></select>
                </div>
                <div class="col-md-5">
                    <label for="endStation" class="form-label">도착역</label>
                    <select id="endStation" class="form-select"></select>
                </div>
                <div class="col-md-2 d-grid">
                    <button class="btn btn-primary" type="button" id="searchBtn">🔍 검색</button>
                </div>
            </div>
            <div id="routeResult" class="route-result d-none">
                <h4 class="mb-3">경로 검색 결과</h4>
                <div id="resultContent" class="result-content"></div>
            </div>
        </div>
    </div>
    
    <hr class="my-4">
    
    <div class="row mb-5">
        <div class="col-12">
            <h2>노선별 역 목록</h2>
            <div class="accordion" id="stationListAccordion">
                </div>
        </div>
    </div>
    
    <hr class="my-4">

    <div class="row chart-container">
        <div class="col-12">
            <h2>노선별 역 개수 통계</h2>
            <canvas id="stationChart"></canvas>
        </div>
    </div>

    <footer class="text-center mt-5 text-muted">
        <small>Powered by Leaflet.js, Chart.js, and Bootstrap | data.go.kr API</small>
    </footer>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
    // 1. 부산 도시철도 전체 역 정보 (CSV 파일 기반)
    const lines = {
        '1호선': [
            { scd: '101', snm: '다대포해수욕장', lat: 35.0476, lng: 128.9715 }, { scd: '102', snm: '다대포항', lat: 35.0535, lng: 128.9774 }, { scd: '103', snm: '낫개', lat: 35.0645, lng: 128.9858 }, { scd: '104', snm: '신장림', lat: 35.0747, lng: 128.9934 }, { scd: '105', snm: '장림', lat: 35.0837, lng: 129.0016 }, { scd: '106', snm: '동매', lat: 35.0945, lng: 129.0118 }, { scd: '107', snm: '신평', lat: 35.1065, lng: 129.0197 }, { scd: '108', snm: '하단', lat: 35.1118, lng: 129.0191 }, { scd: '109', snm: '당리', lat: 35.1205, lng: 129.0163 }, { scd: '110', snm: '사하', lat: 35.1287, lng: 129.0195 }, { scd: '111', snm: '괴정', lat: 35.1378, lng: 129.0232 }, { scd: '112', snm: '대티', lat: 35.1437, lng: 129.0239 }, { scd: '113', snm: '서대신', lat: 35.1477, lng: 129.0298 }, { scd: '114', snm: '동대신', lat: 35.1481, lng: 129.0354 }, { scd: '115', snm: '토성', lat: 35.1051, lng: 129.0435 }, { scd: '116', snm: '자갈치', lat: 35.1452, lng: 129.0277 }, { scd: '117', snm: '남포', lat: 35.1378, lng: 129.0366 }, { scd: '118', snm: '중앙', lat: 35.1052, lng: 129.0445 }, { scd: '119', snm: '부산역', lat: 35.1147, lng: 129.0396 }, { scd: '120', snm: '초량', lat: 35.1206, lng: 129.0456 }, { scd: '121', snm: '좌천', lat: 35.1332, lng: 129.0561 }, { scd: '122', snm: '범일', lat: 35.1372, lng: 129.0645 }, { scd: '123', snm: '범내골', lat: 35.1451, lng: 129.0664 }, { scd: '124', snm: '서면', lat: 35.1578, lng: 129.0592 }, { scd: '125', snm: '부전', lat: 35.1663, lng: 129.0638 }, { scd: '126', snm: '양정', lat: 35.1706, lng: 129.0694 }, { scd: '127', snm: '시청', lat: 35.1772, lng: 129.0734 }, { scd: '128', snm: '연산', lat: 35.1884, lng: 129.0784 }, { scd: '129', snm: '교대', lat: 35.2012, lng: 129.0788 }, { scd: '130', snm: '동래', lat: 35.2017, lng: 129.0838 }, { scd: '131', snm: '명륜', lat: 35.2104, lng: 129.0827 }, { scd: '132', snm: '온천장', lat: 35.2152, lng: 129.0877 }, { scd: '133', snm: '부산대', lat: 35.2285, lng: 129.0831 }, { scd: '134', snm: '장전', lat: 35.2343, lng: 129.0911 }, { scd: '135', snm: '구서', lat: 35.2415, lng: 129.0916 }, { scd: '136', snm: '두실', lat: 35.2505, lng: 129.0924 }, { scd: '137', snm: '남산', lat: 35.2599, lng: 129.0927 }, { scd: '138', snm: '범어사', lat: 35.2711, lng: 129.0954 }, { scd: '139', snm: '노포', lat: 35.2892, lng: 129.0929 }
        ],
        '2호선': [
            { scd: '201', snm: '장산', lat: 35.1729, lng: 129.1764 }, { scd: '202', snm: '중동', lat: 35.1687, lng: 129.1704 }, { scd: '203', snm: '해운대', lat: 35.1633, lng: 129.1627 }, { scd: '204', snm: '동백', lat: 35.1585, lng: 129.1554 }, { scd: '205', snm: '벡스코', lat: 35.1685, lng: 129.1352 }, { scd: '206', snm: '센텀시티', lat: 35.1691, lng: 129.1332 }, { scd: '207', snm: '민락', lat: 35.1611, lng: 129.1245 }, { scd: '208', snm: '수영', lat: 35.1673, lng: 129.1176 }, { scd: '209', snm: '광안', lat: 35.1541, lng: 129.1176 }, { scd: '210', snm: '금련산', lat: 35.1517, lng: 129.1105 }, { scd: '211', snm: '남천', lat: 35.1472, lng: 129.1037 }, { scd: '212', snm: '경성대부경대', lat: 35.1416, lng: 129.1012 }, { scd: '213', snm: '대연', lat: 35.1381, lng: 129.0954 }, { scd: '214', snm: '못골', lat: 35.1337, lng: 129.0903 }, { scd: '215', snm: '지게골', lat: 35.1306, lng: 129.0831 }, { scd: '216', snm: '문현', lat: 35.1274, lng: 129.0768 }, { scd: '217', snm: '국제금융센터·부산은행', lat: 35.1415, lng: 129.0683 }, { scd: '218', snm: '전포', lat: 35.1506, lng: 129.0645 }, { scd: '219', snm: '서면', lat: 35.1578, lng: 129.0592 }, { scd: '220', snm: '부암', lat: 35.1654, lng: 129.0543 }, { scd: '221', snm: '가야', lat: 35.1697, lng: 129.0475 }, { scd: '222', snm: '동의대', lat: 35.1764, lng: 129.0435 }, { scd: '223', snm: '개금', lat: 35.1841, lng: 129.0354 }, { scd: '224', snm: '냉정', lat: 35.1873, lng: 129.0277 }, { scd: '225', snm: '주례', lat: 35.1837, lng: 129.0195 }, { scd: '226', snm: '감전', lat: 35.1754, lng: 129.0097 }, { scd: '227', snm: '사상', lat: 35.1557, lng: 128.9818 }, { scd: '228', snm: '덕포', lat: 35.1664, lng: 128.9959 }, { scd: '229', snm: '모덕', lat: 35.1751, lng: 129.0018 }, { scd: '230', snm: '모라', lat: 35.1856, lng: 128.9955 }, { scd: '231', snm: '구남', lat: 35.1951, lng: 129.0014 }, { scd: '232', snm: '구명', lat: 35.2014, lng: 128.9972 }, { scd: '233', snm: '덕천', lat: 35.2104, lng: 129.0028 }, { scd: '234', snm: '수정', lat: 35.2163, lng: 129.0021 }, { scd: '235', snm: '화명', lat: 35.2241, lng: 129.0045 }, { scd: '236', snm: '율리', lat: 35.2325, lng: 129.0067 }, { scd: '237', snm: '동원', lat: 35.2427, lng: 129.0118 }, { scd: '238', snm: '금곡', lat: 35.2541, lng: 129.0142 }, { scd: '239', snm: '호포', lat: 35.2676, lng: 129.0121 }, { scd: '240', snm: '증산', lat: 35.2783, lng: 129.0084 }, { scd: '241', snm: '부산대양산캠퍼스', lat: 35.2865, lng: 129.0055 }, { scd: '242', snm: '남양산', lat: 35.3021, lng: 129.0135 }, { scd: '243', snm: '양산', lat: 35.3087, lng: 129.0223 }
        ],
        '3호선': [
            { scd: '301', snm: '수영', lat: 35.1673, lng: 129.1176 }, { scd: '302', snm: '배산', lat: 35.1747, lng: 129.1037 }, { scd: '303', snm: '망미', lat: 35.1845, lng: 129.0965 }, { scd: '304', snm: '종합운동장', lat: 35.1904, lng: 129.0881 }, { scd: '305', snm: '사직', lat: 35.1953, lng: 129.0847 }, { scd: '306', snm: '미남', lat: 35.1979, lng: 129.0664 }, { scd: '307', snm: '덕천', lat: 35.2104, lng: 129.0028 }, { scd: '308', snm: '구포', lat: 35.2073, lng: 128.9959 }, { scd: '309', snm: '강서구청', lat: 35.2045, lng: 128.9818 }, { scd: '310', snm: '체육공원', lat: 35.2098, lng: 128.9712 }, { scd: '311', snm: '대저', lat: 35.2153, lng: 128.9664 }
        ],
        '4호선': [
            { scd: '401', snm: '미남', lat: 35.1979, lng: 129.0664 }, { scd: '402', snm: '동래', lat: 35.2017, lng: 129.0838 }, { scd: '403', snm: '낙민', lat: 35.2072, lng: 129.0911 }, { scd: '404', snm: '충렬사', lat: 35.2151, lng: 129.1017 }, { scd: '405', snm: '명장', lat: 35.2205, lng: 129.1098 }, { scd: '406', snm: '서동', lat: 35.2255, lng: 129.1174 }, { scd: '407', snm: '금사', lat: 35.2307, lng: 129.1235 }, { scd: '408', snm: '반여농산물시장', lat: 35.2349, lng: 129.1305 }, { scd: '409', snm: '석대', lat: 35.2391, lng: 129.1386 }, { scd: '410', snm: '영산대', lat: 35.2443, lng: 129.1465 }, { scd: '411', snm: '동부산대학', lat: 35.2497, lng: 129.1541 }, { scd: '412', snm: '고촌', lat: 35.2534, lng: 129.1622 }, { scd: '413', snm: '안평', lat: 35.2582, lng: 129.1683 }
        ]
    };
    
    // 2. Leaflet 지도 초기화
    const map = L.map('map').setView([35.1795, 129.0756], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    // 3. 지도에 역 마커 추가
    const lineColors = {
        '1호선': '#E63333',
        '2호선': '#00B168',
        '3호선': '#FF8F00',
        '4호선': '#60469E',
        '부산김해경전철': '#00A3DA'
    };
    
    const allStations = Object.keys(lines).flatMap(lineName =>
        lines[lineName].map(station => ({
            ...station,
            line: lineName,
            isTransfer: ['서면', '수영', '미남', '덕천', '동래', '연산', '사상', '대저'].includes(station.snm)
        }))
    );
    
    allStations.forEach(station => {
        const markerColor = lineColors[station.line] || '#6c757d';
        const customIcon = L.divIcon({
            className: `line-marker`,
            html: `<div style="background-color: ${markerColor}; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.2);"></div>`,
            iconSize: [16, 16],
            iconAnchor: [8, 8],
            popupAnchor: [0, -8]
        });

        const marker = L.marker([station.lat, station.lng], { icon: customIcon }).addTo(map);
        const transferText = station.isTransfer ? '<br><b>환승 가능</b> 🔁' : '';
        marker.bindPopup(`<b>${station.snm}역</b><br>${station.line}${transferText}`);
    });

    // 4. 경로 검색 폼 구성 및 기능 구현
    const startStationSelect = document.getElementById('startStation');
    const endStationSelect = document.getElementById('endStation');
    const searchBtn = document.getElementById('searchBtn');
    const routeResultDiv = document.getElementById('routeResult');
    const resultContentDiv = document.getElementById('resultContent');

    allStations.forEach(station => {
        const option = document.createElement('option');
        option.value = station.snm;
        option.textContent = `${station.snm} (${station.line})`;
        startStationSelect.appendChild(option);
        endStationSelect.appendChild(option.cloneNode(true));
    });

    searchBtn.addEventListener('click', async () => {
        const startStationName = startStationSelect.value;
        const endStationName = endStationSelect.value;
        
        if (!startStationName || !endStationName) {
            alert('출발역과 도착역을 모두 선택해주세요.');
            return;
        }
        if (startStationName === endStationName) {
            alert('출발역과 도착역이 같습니다. 다시 선택해주세요.');
            return;
        }

        const serviceKey = 'YOUR_SERVICE_KEY';
        const apiUrl = `https://data.humetro.busan.kr/voc/api/open_api_distance.tnn?serviceKey=${serviceKey}&act=json&startSn=${startStationName}&endSn=${endStationName}`;
        
        routeResultDiv.classList.add('d-none');
        resultContentDiv.innerHTML = `<div class="text-center text-muted">경로를 검색 중입니다...</div>`;

        try {
            const response = await fetch(apiUrl);
            if (!response.ok) {
                throw new Error(`API 호출 실패: ${response.status}`);
            }

            const data = await response.json();
            
            if (data.header.resultCode !== '00') {
                 throw new Error(`API 응답 오류: ${data.header.resultMsg}`);
            }

            const result = data.body;
            const totalTime = Math.round(result.time / 60);
            const totalDistance = (result.dist / 10).toFixed(1);

            resultContentDiv.innerHTML = `
                <p><strong>출발역:</strong> ${startStationName} | <strong>도착역:</strong> ${endStationName}</p>
                <p><strong>총 소요 시간:</strong> 약 <span class="text-primary">${totalTime}분</span></p>
                <p><strong>총 이동 거리:</strong> 약 <span class="text-primary">${totalDistance}km</span></p>
            `;
            routeResultDiv.classList.remove('d-none');

        } catch (error) {
            console.error('API 호출 오류:', error);
            resultContentDiv.innerHTML = `<p class="text-danger">경로 검색 중 오류가 발생했습니다.<br>${error.message}</p>`;
            routeResultDiv.classList.remove('d-none');
        }
    });

    // 5. 노선별 아코디언 목록 동적 생성
    const accordion = document.getElementById('stationListAccordion');
    
    Object.keys(lines).forEach((lineName, index) => {
        const lineClass = lineName.replace('호선', '');
        const lineStations = lines[lineName];
        
        const accordionItem = document.createElement('div');
        accordionItem.classList.add('accordion-item');
        
        const buttonId = `collapse-${index}`;
        const targetId = `collapse${index}`;

        let stationListHtml = '';
        lineStations.forEach(station => {
            const transferIcon = allStations.find(s => s.snm === station.snm && s.isTransfer) ? ' <i class="bi bi-arrow-right-circle-fill" style="color:#f39c12;"></i>' : '';
            stationListHtml += `<li class="list-group-item">${station.snm} ${transferIcon}</li>`;
        });

        accordionItem.innerHTML = `
            <h2 class="accordion-header" id="heading-${index}">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#${targetId}" aria-expanded="false" aria-controls="${targetId}">
                    <span class="line-icon line-${lineClass}-bg">${lineClass}</span>
                    <span style="font-weight: 600;">${lineName}</span>
                </button>
            </h2>
            <div id="${targetId}" class="accordion-collapse collapse" aria-labelledby="heading-${index}" data-bs-parent="#stationListAccordion">
                <div class="accordion-body p-0">
                    <ul class="list-group list-group-flush">
                        ${stationListHtml}
                    </ul>
                </div>
            </div>
        `;
        accordion.appendChild(accordionItem);
    });

    // 6. Chart.js 통계 차트 생성
    const stationCounts = {};
    Object.keys(lines).forEach(lineName => {
        stationCounts[lineName] = lines[lineName].length;
    });

    const labels = Object.keys(stationCounts);
    const data = Object.values(stationCounts);

    const ctx = document.getElementById('stationChart').getContext('2d');
    const stationChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: '총 역 개수',
                data: data,
                backgroundColor: [
                    'rgba(231, 76, 60, 0.8)',
                    'rgba(46, 204, 113, 0.8)',
                    'rgba(52, 152, 219, 0.8)',
                    'rgba(155, 89, 182, 0.8)',
                ],
                borderColor: [
                    'rgba(231, 76, 60, 1)',
                    'rgba(46, 204, 113, 1)',
                    'rgba(52, 152, 219, 1)',
                    'rgba(155, 89, 182, 1)',
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: '역 개수'
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
</script>

</body>
</html>
